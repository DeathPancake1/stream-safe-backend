// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  firstname String
  lastname  String
  password  String
  created   DateTime @default(now())
  deviceId  String?  @unique
  deviceIdLastUpdate   DateTime?
  publicKey String?

  // Relationships
  photo Photo? @relation(fields: [photoId], references: [id])
  photoId   Int? @unique
  subscripedChannels  Channel[] @relation("Subscriptions")
  ownedChannels Channel[] @relation("OwnedChannels")
  invitedChannels Channel[] @relation("InvitedUsers")
  exchangedKeysForSender ExchangedKey[] @relation("senderEmails")
  exchangedKeysForReceiver ExchangedKey[] @relation("receiverEmails")
  savedFilesForSender SavedFile[]  @relation("senderSavedFiles")
  savedFilesForReceiver SavedFile[]  @relation("receiverSavedFiles")

}

model Photo {
  id        Int   @id @default(autoincrement())
  url       String
  created   DateTime @default(now())

  // Relationships
  owner     User?
  channel   Channel?
}

model Channel {
  id        Int     @id @default(autoincrement())
  title     String
  description String
  tag      String
  private   Boolean
  created DateTime  @default(now())
  lastActive  DateTime @updatedAt

  // Relationshitps
  subscriptionPlan  Subscription @relation(fields: [subscriptionId], references: [id])
  subscriptionId    Int
  owner User @relation("OwnedChannels", fields: [ownerId], references: [id])
  ownerId Int
  thumbnail Photo @relation(fields: [thumbnailId], references: [id])
  thumbnailId Int @unique
  subscribers   User[] @relation("Subscriptions")
  invitedUsers  User[] @relation("InvitedUsers")
}

model Subscription {
  id        Int @id @default(autoincrement())
  title     String
  description String
  price     Float

  // Relationships
  subscripedChannels  Channel[]
}

model ExchangedKey{
  id  Int @id @default(autoincrement())
  sender User @relation("senderEmails",fields:[senderEmail],references: [email]) 
  senderEmail  String
  receiver User @relation("receiverEmails",fields:[receiverEmail],references: [email]) 
  receiverEmail  String
  delivered  Boolean
  encryptedKey String 
  files SavedFile[]
  exchangedDate DateTime @default(now())
}

model SavedFile{
  id  Int @id @default(autoincrement())
  sender User @relation("senderSavedFiles",fields:[senderEmail],references: [email]) 
  senderEmail  String
  receiver User @relation("receiverSavedFiles",fields:[receiverEmail],references: [email]) 
  receiverEmail  String
  exchangedKey  ExchangedKey @relation(fields:[idOfEncryptedKey],references: [id])
  idOfEncryptedKey Int
  name  String
  type String
  iv String
  path String @unique
  size  Int
  sentDate DateTime @default(now())
  delivered Boolean
}